configfile:
    "config_files/snake-phylosift.config.json"

sample_ids, = glob_wildcards(config['assemblies']+"/{sample}.fasta")

print(sample_ids)

rule all:
    input:
        expand("PSout/{sample}.out", sample=sample_ids),
        "Phylosift.tree"

rule phylosift:
    input:
        config['assemblies']+"/{sample}.fasta",
    output:
        directory("PSout/{sample}.out")
    shell:
        """
        phylosift_v1.0.1/bin/phylosift search --threads 64 --debug --isolate --besthit --output {output} {input}
        phylosift_v1.0.1/bin/phylosift  align --threads 64 --debug --isolate --besthit --output {output} {input}
        """

rule phylosift_process:
    output:
        "Phylosift.tree"
    shell:
        """
        cat PSout/*/alignDir/concat.updated.1.fasta > concat_PS.fasta
        perl -p -i -e "s/\.fasta.+//g" concat_PS.fasta
        phylosift_v1.0.1/bin/FastTree -nt -gtr <concat_PS.fasta> Phylosift.tree
        """
